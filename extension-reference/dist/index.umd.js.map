{"version":3,"file":"index.umd.js","sources":["../src/reference.ts"],"sourcesContent":["import { mergeAttributes, Node } from '@tiptap/core'\r\nimport { Node as ProseMirrorNode } from '@tiptap/pm/model'\r\nimport { PluginKey } from '@tiptap/pm/state'\r\nimport Suggestion, { SuggestionOptions } from '@tiptap/suggestion'\r\n\r\nexport type ReferenceOptions = {\r\n  HTMLAttributes: Record<string, any>\r\n  renderLabel: (props: { options: ReferenceOptions; node: ProseMirrorNode }) => string\r\n  suggestion: Omit<SuggestionOptions, 'editor'>\r\n}\r\n\r\nexport const ReferencePluginKey = new PluginKey('Reference')\r\n\r\nexport const Reference = Node.create<ReferenceOptions>({\r\n  name: 'Reference',\r\n\r\n  addOptions() {\r\n    return {\r\n      HTMLAttributes: {},\r\n      renderLabel({ options, node }) {\r\n        return `${options.suggestion.char}${node.attrs.label ?? node.attrs.id}`\r\n      },\r\n      suggestion: {\r\n        char: '<>',\r\n        pluginKey: ReferencePluginKey,\r\n        command: ({ editor, range, props }) => {\r\n          // increase range.to by one when the next node is of type \"text\"\r\n          // and starts with a space character\r\n          const nodeAfter = editor.view.state.selection.$to.nodeAfter\r\n          const overrideSpace = nodeAfter?.text?.startsWith(' ')\r\n\r\n          if (overrideSpace) {\r\n            range.to += 1\r\n          }\r\n\r\n          editor\r\n            .chain()\r\n            .focus()\r\n            .insertContentAt(range, [\r\n              {\r\n                type: this.name,\r\n                attrs: props,\r\n              },\r\n              {\r\n                type: 'text',\r\n                text: ' ',\r\n              },\r\n            ])\r\n            .run()\r\n\r\n          window.getSelection()?.collapseToEnd()\r\n        },\r\n        allow: ({ state, range }) => {\r\n          const $from = state.doc.resolve(range.from)\r\n          const type = state.schema.nodes[this.name]\r\n          const allow = !!$from.parent.type.contentMatch.matchType(type)\r\n\r\n          return allow\r\n        },\r\n      },\r\n    }\r\n  },\r\n\r\n  group: 'inline',\r\n\r\n  inline: true,\r\n\r\n  selectable: false,\r\n\r\n  atom: true,\r\n\r\n  addAttributes() {\r\n    return {\r\n      id: {\r\n        default: null,\r\n        parseHTML: element => element.getAttribute('data-id'),\r\n        renderHTML: attributes => {\r\n          if (!attributes.id) {\r\n            return {}\r\n          }\r\n\r\n          return {\r\n            'data-id': attributes.id,\r\n          }\r\n        },\r\n      },\r\n\r\n      label: {\r\n        default: null,\r\n        parseHTML: element => element.getAttribute('data-label'),\r\n        renderHTML: attributes => {\r\n          if (!attributes.label) {\r\n            return {}\r\n          }\r\n\r\n          return {\r\n            'data-label': attributes.label,\r\n          }\r\n        },\r\n      },\r\n    }\r\n  },\r\n\r\n  parseHTML() {\r\n    return [\r\n      {\r\n        tag: `span[data-type=\"${this.name}\"]`,\r\n      },\r\n    ]\r\n  },\r\n\r\n  renderHTML({ node, HTMLAttributes }) {\r\n    return [\r\n      'span',\r\n      mergeAttributes({ 'data-type': this.name }, this.options.HTMLAttributes, HTMLAttributes),\r\n      this.options.renderLabel({\r\n        options: this.options,\r\n        node,\r\n      }),\r\n    ]\r\n  },\r\n\r\n  renderText({ node }) {\r\n    return this.options.renderLabel({\r\n      options: this.options,\r\n      node,\r\n    })\r\n  },\r\n\r\n  addKeyboardShortcuts() {\r\n    return {\r\n      Backspace: () => this.editor.commands.command(({ tr, state }) => {\r\n        let isReference = false\r\n        const { selection } = state\r\n        const { empty, anchor } = selection\r\n\r\n        if (!empty) {\r\n          return false\r\n        }\r\n\r\n        state.doc.nodesBetween(anchor - 1, anchor, (node, pos) => {\r\n          if (node.type.name === this.name) {\r\n            isReference = true\r\n            tr.insertText(this.options.suggestion.char || '', pos, pos + node.nodeSize)\r\n\r\n            return false\r\n          }\r\n        })\r\n\r\n        return isReference\r\n      }),\r\n    }\r\n  },\r\n\r\n  addProseMirrorPlugins() {\r\n    return [\r\n      Suggestion({\r\n        editor: this.editor,\r\n        ...this.options.suggestion,\r\n      }),\r\n    ]\r\n  },\r\n})\r\n"],"names":["PluginKey","Node","mergeAttributes","Suggestion"],"mappings":"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"}